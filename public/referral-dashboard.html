<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Referral Dashboard | FundHub</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/repair.css">
  <link rel="stylesheet" href="/css/approved.css">
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif; background:#0f172a; color:#f8fafc; margin:0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 16px 64px; }
    .card { background: #0b1220; border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:18px 20px; margin-bottom:16px; box-shadow:0 10px 30px rgba(0,0,0,0.18); }
    h1, h2, h3 { margin:0 0 8px; }
    .muted { color: #cbd5e1; font-size: 14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px; }
    .stat { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:12px; }
    .value { font-size: 28px; font-weight: 800; }
    .label { color:#94a3b8; font-size:13px; }
    .progress { background: rgba(255,255,255,0.08); border-radius:999px; height:10px; overflow:hidden; margin-top:8px; }
    .progress span { display:block; height:100%; background: linear-gradient(90deg,#38bdf8,#5b7cfa); }
    .suggestions li { margin-bottom:8px; line-height:1.4; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:rgba(56,189,248,0.15); color:#7dd3fc; font-weight:700; font-size:12px; }
    button.share { background:linear-gradient(90deg,#38bdf8,#5b7cfa); color:#0b1220; border:none; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer; width:100%; }
    .warning { color:#fbbf24; font-size:14px; margin-top:10px; }
    a.link { color:#38bdf8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <h1>Referral Dashboard</h1>
          <p class="muted">Track your analyzer status, referral earnings, and share your link.</p>
        </div>
        <div id="resultType" class="badge">Loading…</div>
      </div>
    </div>

    <div id="content" style="display:none;">
      <div class="card">
        <h3>Analyzer Summary</h3>
        <p class="muted" id="summaryText">Loading latest upload…</p>
        <div class="grid">
          <div class="stat">
            <div class="value" id="nextUpload">—</div>
            <div class="label">Next upload window</div>
          </div>
          <div class="stat">
            <div class="value" id="lastUpload">—</div>
            <div class="label">Last upload</div>
          </div>
          <div class="stat">
            <div class="value" id="affiliateLinkLabel">—</div>
            <div class="label">Referral link</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Action Plan</h3>
        <ul id="suggestions" class="suggestions"></ul>
      </div>

      <div class="card">
        <h3>Earnings</h3>
        <div class="grid">
          <div class="stat">
            <div class="value" id="tier1Earnings">$0</div>
            <div class="label">Tier 1 Earnings</div>
            <div class="progress"><span id="tier1Progress" style="width:0%"></span></div>
          </div>
          <div class="stat">
            <div class="value" id="tier2Earnings">$0</div>
            <div class="label">Tier 2 Earnings</div>
            <div class="progress"><span id="tier2Progress" style="width:0%"></span></div>
          </div>
          <div class="stat">
            <div class="value" id="totalEarnings">$0</div>
            <div class="label">Total Earnings</div>
            <div class="progress"><span id="totalProgress" style="width:0%"></span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Referrals</h3>
        <div class="grid">
          <div class="stat">
            <div class="value" id="tier1Count">0</div>
            <div class="label">Tier 1 Referrals</div>
            <div class="progress"><span id="tier1CountBar" style="width:0%"></span></div>
          </div>
          <div class="stat">
            <div class="value" id="tier2Count">0</div>
            <div class="label">Tier 2 Referrals</div>
            <div class="progress"><span id="tier2CountBar" style="width:0%"></span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Share</h3>
        <p class="muted">Share your referral link and earn on successful analyzer submissions.</p>
        <button class="share" id="shareBtn">Share Referral Link</button>
        <div id="shareStatus" class="muted" style="margin-top:8px;"></div>
      </div>

      <div id="warning" class="warning" style="display:none;"></div>
    </div>

    <div id="emptyState" class="card" style="display:none;">
      <h3>Waiting for your analyzer result</h3>
      <p class="muted">We couldn't find an active session. Upload your report again to generate a referral dashboard.</p>
      <a class="link" href="/credit-analyzer.html">Back to Analyzer</a>
    </div>
  </div>

  <script>
    (function initDashboard() {
      window.__config = window.__config || {};
      if (typeof window.__config.AFFILIATE_DASHBOARD_ENABLED === "undefined") {
        window.__config.AFFILIATE_DASHBOARD_ENABLED = "false";
      }
      const affiliateOn = window.__config.AFFILIATE_DASHBOARD_ENABLED === "true";
      if (!affiliateOn) return;

      const params = new URLSearchParams(window.location.search || "");
      const ref = params.get("ref");
      const API_BASE = "https://underwrite-iq-lite.vercel.app";

      const content = document.getElementById("content");
      const emptyState = document.getElementById("emptyState");
      const warningEl = document.getElementById("warning");
      const resultTypeEl = document.getElementById("resultType");

      if (!ref) {
        emptyState.style.display = "block";
        resultTypeEl.textContent = "No ref id";
        return;
      }

      function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value || "—";
      }

      function pct(num) {
        if (!num || num <= 0) return 0;
        const capped = Math.min(Number(num) || 0, 10);
        return Math.max(0, Math.min(100, Math.round((capped / 10) * 100)));
      }

      async function fetchJson(url) {
        try {
          const resp = await fetch(url);
          return await resp.json().catch(() => ({}));
        } catch (_) {
          return null;
        }
      }

      async function loadRedirect() {
        const data = await fetchJson(`${API_BASE}/api/lite/referral-lookup?ref=${encodeURIComponent(ref)}`);
        if (!data || !data.ok || !data.redirect) {
          emptyState.style.display = "block";
          resultTypeEl.textContent = "Unavailable";
          return null;
        }
        return data.redirect;
      }

      function renderRedirect(redirect) {
        const type = redirect.resultType === "funding" ? "Funding" : "Repair";
        resultTypeEl.textContent = type;
        resultTypeEl.style.background = redirect.resultType === "funding"
          ? "rgba(94,234,212,0.15)"
          : "rgba(248,113,113,0.15)";
        resultTypeEl.style.color = redirect.resultType === "funding" ? "#5eead4" : "#fca5a5";

        const days = Number(redirect.daysRemaining ?? 0);
        setText("nextUpload", days > 0 ? `${days} days` : "Now");
        setText("lastUpload", redirect.lastUpload ? new Date(redirect.lastUpload).toLocaleDateString() : "—");

        const summary = redirect.resultType === "funding"
          ? "You are fundable. Review your steps and share your link below."
          : "We have a repair path for you. Review the action items and share your link.";
        setText("summaryText", summary);

        const list = document.getElementById("suggestions");
        list.innerHTML = "";
        (redirect.suggestions || []).forEach(item => {
          const li = document.createElement("li");
          const title = item.title || "Action";
          const desc = item.description || "";
          li.innerHTML = `<strong>${title}:</strong> ${desc}`;
          list.appendChild(li);
        });

        const link = redirect.affiliateLink || (redirect.refId ? `/credit-analyzer.html?ref=${encodeURIComponent(redirect.refId)}` : "");
        setText("affiliateLinkLabel", link);
        document.getElementById("shareBtn").dataset.link = link;
        content.style.display = "block";
      }

      function renderStats(stats, warning) {
        if (warning) {
          warningEl.style.display = "block";
          warningEl.textContent = warning;
        }

        setText("tier1Earnings", `$${Number(stats.tier1_earnings || 0).toLocaleString()}`);
        setText("tier2Earnings", `$${Number(stats.tier2_earnings || 0).toLocaleString()}`);
        setText("totalEarnings", `$${Number(stats.total_earnings || 0).toLocaleString()}`);
        setText("tier1Count", Number(stats.tier1_referrals_count || 0).toString());
        setText("tier2Count", Number(stats.tier2_referrals_count || 0).toString());

        const setWidth = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.style.width = `${pct(val)}%`;
        };
        setWidth("tier1Progress", stats.tier1_earnings);
        setWidth("tier2Progress", stats.tier2_earnings);
        setWidth("totalProgress", stats.total_earnings);
        setWidth("tier1CountBar", stats.tier1_referrals_count);
        setWidth("tier2CountBar", stats.tier2_referrals_count);
      }

      function bindShare(link) {
        const btn = document.getElementById("shareBtn");
        const status = document.getElementById("shareStatus");
        if (!btn) return;

        btn.onclick = async () => {
          const finalLink = btn.dataset.link || link;
          if (!finalLink) {
            status.textContent = "No link available.";
            return;
          }

          try {
            if (navigator.share) {
              await navigator.share({ title: "FundHub Referral", url: finalLink });
              status.textContent = "Shared!";
            } else if (navigator.clipboard?.writeText) {
              await navigator.clipboard.writeText(finalLink);
              status.textContent = "Link copied.";
            } else {
              status.textContent = finalLink;
            }
          } catch (_) {
            status.textContent = "Unable to share right now.";
          }
        };
      }

      (async function run() {
        const redirect = await loadRedirect();
        if (!redirect) return;
        renderRedirect(redirect);
        bindShare(redirect.affiliateLink);

        const statsResp = await fetchJson(`${API_BASE}/api/lite/affiliate-stats?ref=${encodeURIComponent(ref)}`);
        if (statsResp) {
          renderStats(statsResp.stats || {}, statsResp.warning);
        } else {
          renderStats({}, "Referral stats updating — check back soon.");
        }
      })();
    })();
  </script>
</body>
</html>
